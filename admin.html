<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Siam's Insight</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            color: #333;
            background-color: #f9fafb;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* General button styles for consistency */
        .btn-primary {
            @apply bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition duration-200;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-200;
        }
        .btn-danger {
            @apply bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-200;
        }
        .btn-success {
            @apply bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200;
        }

        /* Sidebar Navigation Styles */
        .sidebar-nav-item {
            @apply flex items-center p-3 my-2 rounded-lg text-gray-700 hover:bg-indigo-100 hover:text-indigo-700 transition duration-200 cursor-pointer;
        }
        .sidebar-nav-item.active {
            @apply bg-indigo-500 text-white shadow-md;
        }
        .sidebar-nav-item.active:hover {
            @apply bg-indigo-600;
        }

        /* Content sections */
        .admin-content-section {
            display: none; /* Hidden by default */
        }
        .admin-content-section.active {
            display: block; /* Shown when active */
        }
    </style>
</head>
<body>

    <!-- Header Section for Admin Panel -->
    <header class="bg-indigo-800 text-white p-4 shadow-md z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold">Admin Panel - Siam's Insight</h1>
            <button id="logoutButton" class="btn-danger">Logout</button>
        </div>
    </header>

    <!-- Admin Content Area -->
    <main class="flex h-[calc(100vh-64px)] overflow-hidden"> <!-- Adjusted height to fill screen below header -->

        <!-- Login Form (Initially visible) -->
        <section id="loginSection" class="bg-white p-8 rounded-lg shadow-xl max-w-md mx-auto my-auto">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Admin Login</h2>
            <div class="mb-4">
                <label for="loginEmail" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                <input type="email" id="loginEmail" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md" placeholder="admin@example.com">
            </div>
            <div class="mb-6">
                <label for="loginPassword" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                <input type="password" id="loginPassword" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md" placeholder="**********">
            </div>
            <!-- Visualized Login Button -->
            <button id="loginButton" class="w-full py-3 text-lg font-semibold rounded-lg shadow-lg
                                         bg-gradient-to-r from-indigo-600 to-purple-700 text-white
                                         hover:from-indigo-700 hover:to-purple-800
                                         transform hover:scale-105 transition duration-300 ease-in-out">
                Login
            </button>
            <p id="loginMessage" class="text-center text-red-500 mt-4"></p>
        </section>

        <!-- Main Admin Dashboard (Hidden until login) -->
        <section id="adminDashboard" class="hidden flex flex-1">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-white p-6 shadow-md border-r border-gray-200">
                <nav>
                    <ul class="space-y-2">
                        <li>
                            <button type="button" data-section-target="blog-management" class="sidebar-nav-item active">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Blog Management
                            </button>
                        </li>
                        <li>
                            <button type="button" data-section-target="document-management" class="sidebar-nav-item">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Document Management
                            </button>
                        </li>
                        <li>
                            <button type="button" data-section-target="purchase-requests" class="sidebar-nav-item">
                                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h10m-9 4h8a2 2 0 002-2V6a2 2 0 00-2-2H7a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Purchase Requests
                            </button>
                        </li>
                    </ul>
                </nav>
            </aside>

            <!-- Main Content Area (Scrollable) -->
            <div class="flex-1 p-6 overflow-y-auto">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Welcome, Admin!</h2>

                <!-- Blog Management Section -->
                <section id="blog-management" class="admin-content-section active bg-white p-8 rounded-lg shadow-xl mb-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6">Blog Post Management</h3>

                    <!-- Add/Edit Blog Post Form -->
                    <div class="mb-8 p-6 border rounded-lg bg-gray-50">
                        <h4 class="text-2xl font-semibold text-gray-700 mb-4" id="blogFormTitle">Add New Blog Post</h4>
                        <input type="hidden" id="blogPostId">
                        <div class="mb-4">
                            <label for="blogTitle" class="block text-gray-700 text-sm font-bold mb-2">Title</label>
                            <input type="text" id="blogTitle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-4">
                            <label for="blogSlug" class="block text-gray-700 text-sm font-bold mb-2">Slug (URL friendly, auto-generated if empty)</label>
                            <input type="text" id="blogSlug" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md" placeholder="e.g., my-first-blog-post">
                        </div>
                        <div class="mb-4">
                            <label for="blogContent" class="block text-gray-700 text-sm font-bold mb-2">Content</label>
                            <textarea id="blogContent" rows="10" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="blogAuthor" class="block text-gray-700 text-sm font-bold mb-2">Author</label>
                            <input type="text" id="blogAuthor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md" value="Shifat Siam">
                        </div>
                        <div class="mb-4">
                            <label for="blogReadTime" class="block text-gray-700 text-sm font-bold mb-2">Read Time (e.g., 5 min)</label>
                            <input type="text" id="blogReadTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-6">
                            <label for="blogImageUrl" class="block text-gray-700 text-sm font-bold mb-2">Image URL (Placeholder URL or actual image)</label>
                            <input type="url" id="blogImageUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="flex space-x-4">
                            <button id="saveBlogPostButton" class="btn-primary">Save Blog Post</button>
                            <button id="cancelEditBlogPostButton" class="btn-secondary hidden">Cancel Edit</button>
                        </div>
                    </div>

                    <!-- Blog Posts List -->
                    <div>
                        <h4 class="text-2xl font-semibold text-gray-700 mb-4">Existing Blog Posts</h4>
                        <div id="blogPostsList" class="space-y-4">
                            <!-- Blog posts will be loaded here dynamically -->
                            <p class="text-gray-600 text-center">Loading blog posts...</p>
                        </div>
                    </div>
                </section>

                <!-- Premium Document Management Section -->
                <section id="document-management" class="admin-content-section bg-white p-8 rounded-lg shadow-xl mb-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6">Premium Document Management</h3>

                    <!-- Add/Edit Document Form -->
                    <div class="mb-8 p-6 border rounded-lg bg-gray-50">
                        <h4 class="text-2xl font-semibold text-gray-700 mb-4" id="docFormTitle">Add New Premium Document</h4>
                        <input type="hidden" id="docId">
                        <div class="mb-4">
                            <label for="docName" class="block text-gray-700 text-sm font-bold mb-2">Document Name</label>
                            <input type="text" id="docName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-4">
                            <label for="docDescription" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                            <textarea id="docDescription" rows="5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md"></textarea>
                        </div>
                        <div class="mb-4">
                            <label for="docPrice" class="block text-gray-700 text-sm font-bold mb-2">Price (BDT)</label>
                            <input type="number" id="docPrice" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-4">
                            <label for="docPages" class="block text-gray-700 text-sm font-bold mb-2">Number of Pages</label>
                            <input type="number" id="docPages" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-4">
                            <label for="docPreviewImageUrl" class="block text-gray-700 text-sm font-bold mb-2">Preview Image URL</label>
                            <input type="url" id="docPreviewImageUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                        </div>
                        <div class="mb-6">
                            <label for="docExternalDownloadUrl" class="block text-gray-700 text-sm font-bold mb-2">External Download URL (e.g., Google Drive link)</label>
                            <input type="url" id="docExternalDownloadUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                            <p class="text-sm text-gray-500 mt-1">Provide a direct public link if using external storage (e.g., Google Drive, Dropbox).</p>
                        </div>
                        <div class="mb-6">
                            <label for="docAccessType" class="block text-gray-700 text-sm font-bold mb-2">Access Type</label>
                            <select id="docAccessType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded-md">
                                <option value="bkash_payment">Bkash Payment</option>
                                <option value="ad_watch">Ad Watch</option>
                            </select>
                        </div>
                        <div class="flex space-x-4">
                            <button id="saveDocButton" class="btn-primary">Save Document</button>
                            <button id="cancelEditDocButton" class="btn-secondary hidden">Cancel Edit</button>
                        </div>
                    </div>

                    <!-- Premium Documents List -->
                    <div>
                        <h4 class="text-2xl font-semibold text-gray-700 mb-4">Existing Premium Documents</h4>
                        <div id="premiumDocumentsList" class="space-y-4">
                            <!-- Documents will be loaded here dynamically -->
                            <p class="text-gray-600 text-center">Loading documents...</p>
                        </div>
                    </div>
                </section>

                <!-- Purchase Requests Section -->
                <section id="purchase-requests" class="admin-content-section bg-white p-8 rounded-lg shadow-xl mb-8">
                    <h3 class="text-3xl font-bold text-gray-800 mb-6">Purchase Requests (Bkash)</h3>
                    <div id="purchaseRequestsList" class="space-y-4">
                        <!-- Purchase requests will be loaded here dynamically -->
                        <p class="text-gray-600 text-center">Loading purchase requests...</p>
                    </div>
                </section>
            </div>
        </section>

        <!-- Message/Notification Area (for general feedback) -->
        <div id="messageArea" class="fixed bottom-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg hidden z-50"></div>

    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Your web app's Firebase configuration (COPY FROM YOUR FIREBASE PROJECT SETTINGS)
        const firebaseConfig = {
            apiKey: "AIzaSyCGY3j4yIpHMkc4DOcFBhzs2hfEVsw0VJ0",
            authDomain: "siamwebsite2022.firebaseapp.com",
            projectId: "siamwebsite2022",
            storageBucket: "siamwebsite2022.firebasestorage.app",
            messagingSenderId: "964747721403",
            appId: "1:964747721403:web:1860b8c0533bcf6d6cc79e"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        const auth = app.auth();

        // --- Admin UID ---
        // IMPORTANT: Replace this with your actual Firebase Admin User UID.
        // You obtained this in Step 2.D of the setup guide.
        const ADMIN_UID = 'z2MTiFRlTGcDYIaft5zxkjBM8rS2';

        // --- DOM Elements ---
        const loginSection = document.getElementById('loginSection');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginMessage = document.getElementById('loginMessage');
        const logoutButton = document.getElementById('logoutButton');
        const messageArea = document.getElementById('messageArea');

        // Sidebar navigation elements
        const sidebarNavItems = document.querySelectorAll('.sidebar-nav-item');
        const adminContentSections = document.querySelectorAll('.admin-content-section');


        // Blog elements
        const blogFormTitle = document.getElementById('blogFormTitle');
        const blogPostIdInput = document.getElementById('blogPostId');
        const blogTitleInput = document.getElementById('blogTitle');
        const blogSlugInput = document.getElementById('blogSlug');
        const blogContentInput = document.getElementById('blogContent');
        const blogAuthorInput = document.getElementById('blogAuthor');
        const blogReadTimeInput = document.getElementById('blogReadTime');
        const blogImageUrlInput = document.getElementById('blogImageUrl');
        const saveBlogPostButton = document.getElementById('saveBlogPostButton');
        const cancelEditBlogPostButton = document.getElementById('cancelEditBlogPostButton');
        const blogPostsList = document.getElementById('blogPostsList');

        // Document elements
        const docFormTitle = document.getElementById('docFormTitle');
        const docIdInput = document.getElementById('docId');
        const docNameInput = document.getElementById('docName');
        const docDescriptionInput = document.getElementById('docDescription');
        const docPriceInput = document.getElementById('docPrice');
        const docPagesInput = document.getElementById('docPages');
        const docPreviewImageUrlInput = document.getElementById('docPreviewImageUrl');
        const docExternalDownloadUrlInput = document.getElementById('docExternalDownloadUrl');
        const docAccessTypeInput = document.getElementById('docAccessType');
        const saveDocButton = document.getElementById('saveDocButton');
        const cancelEditDocButton = document.getElementById('cancelEditDocButton');
        const premiumDocumentsList = document.getElementById('premiumDocumentsList');

        // Purchase Requests
        const purchaseRequestsList = document.getElementById('purchaseRequestsList');

        // --- Utility Functions ---
        function showMessage(msg, type = 'success') {
            messageArea.textContent = msg;
            messageArea.className = `fixed bottom-4 right-4 p-3 rounded-lg shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white`;
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 3000);
        }

        // Function to generate a URL-friendly slug
        function generateSlug(title) {
            return title
                .toLowerCase()
                .trim()
                .replace(/[^\w\s-]/g, '') // Remove all non-word chars except spaces and hyphens
                .replace(/[\s_-]+/g, '-') // Replace spaces and multiple hyphens with a single hyphen
                .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
        }

        function clearBlogPostForm() {
            blogFormTitle.textContent = 'Add New Blog Post';
            blogPostIdInput.value = '';
            blogTitleInput.value = '';
            blogSlugInput.value = '';
            blogContentInput.value = '';
            blogReadTimeInput.value = '';
            blogImageUrlInput.value = '';
            saveBlogPostButton.textContent = 'Save Blog Post';
            cancelEditBlogPostButton.classList.add('hidden');
        }

        function clearDocForm() {
            docFormTitle.textContent = 'Add New Premium Document';
            docIdInput.value = '';
            docNameInput.value = '';
            docDescriptionInput.value = '';
            docPriceInput.value = '';
            docPagesInput.value = '';
            docPreviewImageUrlInput.value = '';
            docExternalDownloadUrlInput.value = '';
            docAccessTypeInput.value = 'bkash_payment'; // Default value
            saveDocButton.textContent = 'Save Document';
            cancelEditDocButton.classList.add('hidden');
        }

        // --- Sidebar Navigation Logic ---
        sidebarNavItems.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.sectionTarget;
                const targetContent = document.getElementById(targetId);

                adminContentSections.forEach(content => content.classList.remove('active'));
                sidebarNavItems.forEach(btn => btn.classList.remove('active'));

                targetContent.classList.add('active');
                button.classList.add('active');
            });
        });


        // --- Authentication Logic ---
        // Listen for authentication state changes
        auth.onAuthStateChanged(user => {
            if (user && user.uid === ADMIN_UID) {
                // Admin is logged in
                loginSection.classList.add('hidden');
                adminDashboard.classList.remove('hidden');
                loadBlogPosts(); // Load initial data
                loadPremiumDocuments();
                loadPurchaseRequests();
                // Ensure initial section is active on login
                document.getElementById('blog-management').classList.add('active');
                document.querySelector('[data-section-target="blog-management"]').classList.add('active');

            } else {
                // Not logged in or not admin
                loginSection.classList.remove('hidden');
                adminDashboard.classList.add('hidden');
                loginMessage.textContent = 'Please log in with admin credentials.';
            }
        });

        // Login Button Click
        loginButton.addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;

            if (!email || !password) {
                loginMessage.textContent = 'Please enter both email and password.';
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (userCredential.user.uid !== ADMIN_UID) {
                    // Logged in user is not the admin, log them out
                    await auth.signOut();
                    loginMessage.textContent = 'Access denied. You are not authorized.';
                } else {
                    loginMessage.textContent = ''; // Clear message on successful login
                    // UI update handled by onAuthStateChanged listener
                }
            } catch (error) {
                console.error("Login error:", error);
                loginMessage.textContent = `Login failed: ${error.message}`;
            }
        });

        // Logout Button Click
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                showMessage('Logged out successfully!', 'success');
                clearBlogPostForm(); // Clear forms on logout
                clearDocForm();
                // UI update handled by onAuthStateChanged listener
            } catch (error) {
                console.error("Logout error:", error);
                showMessage('Error logging out.', 'error');
            }
        });

        // --- Blog Post Management ---
        // Load Blog Posts (Real-time listener)
        function loadBlogPosts() {
            db.collection('blogPosts').orderBy('date', 'desc').onSnapshot(snapshot => {
                blogPostsList.innerHTML = ''; // Clear current list
                if (snapshot.empty) {
                    blogPostsList.innerHTML = '<p class="text-gray-600 text-center">No blog posts found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postId = doc.id;
                    const postElement = `
                        <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
                            <div>
                                <h5 class="text-xl font-semibold text-gray-800">${post.title}</h5>
                                <p class="text-gray-600 text-sm">By ${post.author} | ${new Date(post.date).toLocaleDateString()} | ${post.readTime}</p>
                                <p class="text-gray-500 text-xs mt-1">Slug: <span class="font-mono">${post.slug || 'N/A'}</span></p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editBlogPost('${postId}')" class="btn-secondary text-sm">Edit</button>
                                <button onclick="deleteBlogPost('${postId}')" class="btn-danger text-sm">Delete</button>
                            </div>
                        </div>
                    `;
                    blogPostsList.innerHTML += postElement;
                });
            }, error => {
                console.error("Error loading blog posts:", error);
                showMessage('Error loading blog posts.', 'error');
            });
        }

        // Save Blog Post
        saveBlogPostButton.addEventListener('click', async () => {
            const postId = blogPostIdInput.value;
            const title = blogTitleInput.value.trim();
            let slug = blogSlugInput.value.trim(); // Use let as slug might be updated
            const content = blogContentInput.value.trim();
            const author = blogAuthorInput.value.trim();
            const readTime = blogReadTimeInput.value.trim();
            const imageUrl = blogImageUrlInput.value.trim();

            if (!title || !content || !author || !readTime) {
                showMessage('Please fill in all required blog post fields (Title, Content, Author, Read Time).', 'error');
                return;
            }

            // Auto-generate slug if not provided
            if (!slug) {
                slug = generateSlug(title);
            }

            const blogPostData = {
                title,
                slug, // Ensure slug is saved
                content,
                author,
                readTime,
                imageUrl: imageUrl || 'https://placehold.co/600x400/9ca3af/ffffff?text=Blog+Image', // Default image if none provided
                date: new Date().toISOString() // Update date on save/edit
            };

            try {
                if (postId) {
                    // Update existing post
                    await db.collection('blogPosts').doc(postId).update(blogPostData);
                    showMessage('Blog post updated successfully!', 'success');
                } else {
                    // Add new post
                    // Optional: Check if slug already exists before adding
                    const existingSlug = await db.collection('blogPosts').where('slug', '==', slug).limit(1).get();
                    if (!existingSlug.empty) {
                        showMessage('A blog post with this slug already exists. Please choose a different slug or edit the existing post.', 'error');
                        return;
                    }
                    await db.collection('blogPosts').add(blogPostData);
                    showMessage('New blog post added successfully!', 'success');
                }
                clearBlogPostForm();
            } catch (error) {
                console.error("Error saving blog post:", error);
                showMessage('Error saving blog post.', 'error');
            }
        });

        // Edit Blog Post
        async function editBlogPost(postId) {
            try {
                const doc = await db.collection('blogPosts').doc(postId).get();
                if (doc.exists) {
                    const post = doc.data();
                    blogFormTitle.textContent = 'Edit Blog Post';
                    blogPostIdInput.value = postId;
                    blogTitleInput.value = post.title;
                    blogSlugInput.value = post.slug || ''; // Ensure slug field is populated
                    blogContentInput.value = post.content;
                    blogAuthorInput.value = post.author;
                    blogReadTimeInput.value = post.readTime;
                    blogImageUrlInput.value = post.imageUrl;
                    saveBlogPostButton.textContent = 'Update Blog Post';
                    cancelEditBlogPostButton.classList.remove('hidden');
                    // Scroll to top of form
                    blogFormTitle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    showMessage('Blog post not found.', 'error');
                }
            } catch (error) {
                console.error("Error fetching blog post for edit:", error);
                showMessage('Error fetching blog post for edit.', 'error');
            }
        }

        // Cancel Blog Post Edit
        cancelEditBlogPostButton.addEventListener('click', () => {
            clearBlogPostForm();
        });

        // Delete Blog Post
        async function deleteBlogPost(postId) {
            if (confirm('Are you sure you want to delete this blog post?')) { // Using confirm for simplicity, replace with custom modal in production
                try {
                    await db.collection('blogPosts').doc(postId).delete();
                    showMessage('Blog post deleted successfully!', 'success');
                } catch (error) {
                    console.error("Error deleting blog post:", error);
                    showMessage('Error deleting blog post.', 'error');
                }
            }
        }

        // --- Premium Document Management ---
        // Load Premium Documents (Real-time listener)
        function loadPremiumDocuments() {
            db.collection('premiumDocuments').onSnapshot(snapshot => {
                premiumDocumentsList.innerHTML = ''; // Clear current list
                if (snapshot.empty) {
                    premiumDocumentsList.innerHTML = '<p class="text-gray-600 text-center">No premium documents found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const document = doc.data();
                    const docId = doc.id;
                    const docElement = `
                        <div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center">
                            <div>
                                <h5 class="text-xl font-semibold text-gray-800">${document.name}</h5>
                                <p class="text-gray-600 text-sm">Price: BDT ${document.priceBDT} | Pages: ${document.pages} | Access: ${document.accessType.replace('_', ' ')}</p>
                                <p class="text-gray-500 text-xs mt-1">Link: <span class="font-mono truncate w-80 inline-block">${document.externalDownloadUrl || 'N/A'}</span></p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editDocument('${docId}')" class="btn-secondary text-sm">Edit</button>
                                <button onclick="deleteDocument('${docId}')" class="btn-danger text-sm">Delete</button>
                            </div>
                        </div>
                    `;
                    premiumDocumentsList.innerHTML += docElement;
                });
            }, error => {
                console.error("Error loading premium documents:", error);
                showMessage('Error loading premium documents.', 'error');
            });
        }

        // Save Premium Document
        saveDocButton.addEventListener('click', async () => {
            const docId = docIdInput.value;
            const name = docNameInput.value.trim();
            const description = docDescriptionInput.value.trim();
            const priceBDT = parseFloat(docPriceInput.value);
            const pages = parseInt(docPagesInput.value);
            const previewImageUrl = docPreviewImageUrlInput.value.trim();
            const externalDownloadUrl = docExternalDownloadUrlInput.value.trim();
            const accessType = docAccessTypeInput.value;


            if (!name || !description || isNaN(priceBDT) || isNaN(pages) || !previewImageUrl || !accessType) {
                showMessage('Please fill in all required document fields and ensure price/pages are numbers.', 'error');
                return;
            }

            const documentData = {
                name,
                description,
                priceBDT,
                pages,
                previewImageUrl,
                externalDownloadUrl: externalDownloadUrl || '', // Store empty string if no URL provided
                accessType
            };

            try {
                if (docId) {
                    // Update existing document
                    await db.collection('premiumDocuments').doc(docId).update(documentData);
                    showMessage('Premium document updated successfully!', 'success');
                } else {
                    // Add new document
                    await db.collection('premiumDocuments').add(documentData);
                    showMessage('New premium document added successfully!', 'success');
                }
                clearDocForm();
            } catch (error) {
                console.error("Error saving document:", error);
                showMessage('Error saving document.', 'error');
            }
        });

        // Edit Premium Document
        async function editDocument(docId) {
            try {
                const doc = await db.collection('premiumDocuments').doc(docId).get();
                if (doc.exists) {
                    const document = doc.data();
                    docFormTitle.textContent = 'Edit Premium Document';
                    docIdInput.value = docId;
                    docNameInput.value = document.name;
                    docDescriptionInput.value = document.description;
                    docPriceInput.value = document.priceBDT;
                    docPagesInput.value = document.pages;
                    docPreviewImageUrlInput.value = document.previewImageUrl;
                    docExternalDownloadUrlInput.value = document.externalDownloadUrl || '';
                    docAccessTypeInput.value = document.accessType || 'bkash_payment'; // Set default if not found
                    saveDocButton.textContent = 'Update Document';
                    cancelEditDocButton.classList.remove('hidden');
                    // Scroll to top of form
                    docFormTitle.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    showMessage('Document not found.', 'error');
                }
            } catch (error) {
                console.error("Error fetching document for edit:", error);
                showMessage('Error fetching document for edit.', 'error');
            }
        }

        // Cancel Document Edit
        cancelEditDocButton.addEventListener('click', () => {
            clearDocForm();
        });

        // Delete Premium Document
        async function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this premium document?')) { // Using confirm for simplicity, replace with custom modal in production
                try {
                    await db.collection('premiumDocuments').doc(docId).delete();
                    showMessage('Premium document deleted successfully!', 'success');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showMessage('Error deleting document.', 'error');
                }
            }
        }

        // --- Purchase Request Management (Bkash) ---
        // Load Purchase Requests (Real-time listener, ordered by status and then date)
        function loadPurchaseRequests() {
            db.collection('bkashOrders').orderBy('status').orderBy('orderDate', 'desc').onSnapshot(snapshot => {
                purchaseRequestsList.innerHTML = ''; // Clear current list
                if (snapshot.empty) {
                    purchaseRequestsList.innerHTML = '<p class="text-gray-600 text-center">No purchase requests found.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderId = doc.id;
                    let statusColor = 'bg-yellow-100 text-yellow-800';
                    let actionButtons = '';
                    let downloadLinkDisplay = '';

                    if (order.status === 'pending') {
                        statusColor = 'bg-yellow-100 text-yellow-800';
                        actionButtons = `
                            <input type="url" id="link-${orderId}" class="shadow appearance-none border rounded w-60 py-1 px-2 text-gray-700 leading-tight rounded-md mr-2" placeholder="Document Download URL" value="${order.generatedDownloadLink || ''}">
                            <button onclick="approveOrder('${orderId}', document.getElementById('link-${orderId}').value)" class="btn-success text-sm mr-2">Approve</button>
                            <button onclick="rejectOrder('${orderId}')" class="btn-danger text-sm">Reject</button>
                        `;
                    } else if (order.status === 'approved') {
                        statusColor = 'bg-green-100 text-green-800';
                        downloadLinkDisplay = `<p class="text-xs text-gray-600 mt-2">Link: <a href="${order.generatedDownloadLink}" target="_blank" class="text-blue-500 hover:underline truncate">${order.generatedDownloadLink}</a></p>`;
                    } else if (order.status === 'rejected') {
                        statusColor = 'bg-red-100 text-red-800';
                    }

                    const orderElement = `
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="text-xl font-semibold text-gray-800">Order for: ${order.documentName}</h5>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColor}">${order.status.toUpperCase()}</span>
                            </div>
                            <p class="text-gray-700">Buyer: ${order.buyerName} (${order.buyerEmail})</p>
                            <p class="text-gray-700">Bkash TrxID: <span class="font-mono">${order.bkashTrxId}</span></p>
                            <p class="text-gray-600 text-sm">Order Date: ${new Date(order.orderDate).toLocaleString()}</p>
                            ${downloadLinkDisplay}
                            <div class="mt-3 flex justify-end">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                    purchaseRequestsList.innerHTML += orderElement;
                });
            }, error => {
                console.error("Error loading purchase requests:", error);
                showMessage('Error loading purchase requests.', 'error');
            });
        }

        // Approve Order
        async function approveOrder(orderId, downloadLink) {
            if (!downloadLink.trim()) {
                showMessage('Please provide a download link before approving.', 'error');
                return;
            }
            // Optional: Confirm with the user if the link is correct
            if (confirm('Approve order ' + orderId + ' and record this link: ' + downloadLink + '? Remember to manually send the email to the buyer.')) {
                try {
                    await db.collection('bkashOrders').doc(orderId).update({
                        status: 'approved',
                        generatedDownloadLink: downloadLink,
                        approvalDate: new Date().toISOString()
                    });
                    showMessage('Order approved successfully! Manual email reminder.', 'success');
                } catch (error) {
                    console.error("Error approving order:", error);
                    showMessage('Error approving order.', 'error');
                }
            }
        }

        // Reject Order
        async function rejectOrder(orderId) {
            if (confirm('Are you sure you want to reject this order?')) {
                try {
                    await db.collection('bkashOrders').doc(orderId).update({
                        status: 'rejected',
                        rejectionDate: new Date().toISOString()
                    });
                    showMessage('Order rejected successfully!', 'success');
                } catch (error) {
                        console.error("Error rejecting order:", error);
                    showMessage('Error rejecting order.', 'error');
                }
            }
        }
    </script>
</body>
</html>
